{% load static %}
<!DOCTYPE html>
  <html lang="en">
  <head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Base Template</title>
    {% include 'base/css.html' %}

    {% block base_head %}
    {% endblock %}
  </head>
  <body>
    {% include 'base/navbar.html' with brand_name='eCommerce' %}

    <div class="container">
      {% block content%}
      {% endblock %}
    </div>

    {% include 'base/js.html' %}
    <script>
      $(document).ready(function(){
        let prodcutForm = $('.form-product-add-ajax')
        prodcutForm.submit(function(event){
          event.preventDefault();
          const thisForm = $(this);
          // const actionEndpoint = thisForm.attr('action');
          const actionEndpoint = thisForm.attr('data-endpoint');
          const httpMethod = thisForm.attr('method');
          const formData = thisForm.serialize();
          $.ajax({
            url: actionEndpoint,
            method: httpMethod,
            data: formData,
            success: function(data){
              const submitSpan = thisForm.find('.submit-span');
              if(data.added){
                submitSpan.html("In Cart <button type='submit' class='btn btn-link'>Remove ?</button>");
              }else{
                submitSpan.html("<button type='submit' class='btn btn-success'>Add to Cart</button>");
              }

              const navbarCount = $('.navbar-cart-count')
              navbarCount.text(data.cartItemCount);
              const currentUrl = window.location.href;
              if(currentUrl.indexOf('cart') != -1){
                refreshCart();
              } 
            },
            error: function(errorData){
              console.log(`error: ${errorData}`);
            }
          });
        })

        function refreshCart(){
          const cartTable = $('.cart-table');
          const cartBody = cartTable.find('.cart-body');
          const productRows = cartBody.find('cart-product');
          const currentUrl = window.location.href;
          const refreshCartUrl = '/api/cart/';
          const refreshCartMethod = 'GET';
          $.ajax({
            url: refreshCartUrl,
            method: refreshCartMethod,
            data: {},
            success: function(data){
              console.log('successRefresh');
              console.log(data);
              if(data.products.lenght > 0){
                productRows.html(" ")
                i=data.products.lenght;
                $.each(data.products, function(index, value){
                  console.log(value);
                  cartBody.prepend(`<tr><th scope="row">${i}</th><td><a href='${value.url}'>${value.name}</a> </td><td>${value.price}</td></tr>`);
                  i--
                });
                // productRows.html("<tr><td colspan=3>Coming Soon</td></tr>");
                cartBody.find('.cart-subtotal').text(data.subtotal);
                cartBody.find('.cart-total').text(data.total);
              }else{
                window.location.href = currentUrl;
              }
            },
            error: function(errorData){
              console.log('errorRefresh',errorData);
            }
          });
        }
      })

    </script>
  </body>
</html>